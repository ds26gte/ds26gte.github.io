<!doctype html>
<html lang="en">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
  <script type="module" src="../embed-api.js"></script>
  <script src="../codemirror.js"></script>
  <script src="../runmode.js"></script>
  <script src="../pyret.js"></script>
  <script src="../hilite.js"></script>
  <link rel="stylesheet" type="text/css" href="../codemirror.css" title="default"/>
  <link rel="stylesheet" type="text/css" href="../pyret.css" title="default"/>
  <link rel="stylesheet" type="text/css" href="../styles.css" title="default"/>
  <head>
    <title>Runtime API</title>
  </head>
  <body>
    <div class="container">
    <root><h1 id="runtime" toclevel="1" tocentry="yes">Runtime API</h1><p>Pyret exposes most of its internal operations on the <span class="pyret-highlight"><tt class="pyretexpr">runtime</tt></span> object; most JavaScript code that interacts with Pyret will need to know about the runtime.</p><p>The library that defines runtimes is in <span class="pyret-highlight"><tt class="pyretexpr">src/js/base/runtime-anf.js</tt></span>, and it is configured to be importable with <span class="pyret-highlight"><tt class="pyretexpr">js/runtime-anf</tt></span> via RequireJS:</p><pre class="nothing_special">define(["js/runtime-anf"], function(runtimeLib) {
  // use runtimeLib
});</pre><div><pre class="pyret-display">RuntimeLib.create(options) → Runtime</pre></div><p>Create a new Pyret runtime.  The <span class="pyret-highlight"><tt class="pyretexpr">RuntimeLib</tt></span> value itself only exports this interface, and most other useful functions are referenced from the runtime objecs it creates.  The options are:</p><pre class="nothing_special">options :: {
  initialGas: Number,
  stdout: String → Undefined,
  stderr: String → Undefined
}</pre><p>The size of the Pyret stack is constrained to <span class="pyret-highlight"><tt class="pyretexpr">initialGas</tt></span> frames; most applications have little need to set this.</p><p>For applications that need control over printing, they can set <span class="pyret-highlight"><tt class="pyretexpr">stdout</tt></span> and <span class="pyret-highlight"><tt class="pyretexpr">stderr</tt></span> to get called whenever Pyret would print strings (e.g. via <span class="pyret-highlight"><tt class="pyretexpr">print</tt></span>).  This interface may change to accept all Pyret values at some point, to allow for richer rendering interfaces.</p><h2 id="s:runtime-object" toclevel="2" tocentry="yes">The Pyret Runtime</h2><p>The return value of <internal-id>RuntimeLibcreate</internal-id> is a runtime object with many useful methods for programmatically interacting with Pyret.</p><h3 id="Running-Pyret-Programs" toclevel="3" tocentry="yes">Running Pyret Programs</h3><div><p><span class="margin-note">!→ means this function is not stack safe</span></p><pre>Runtime.runStandalone(
  modules: JSDict&lt;URI, StaticModules&gt;
  dependencies: JSDict&lt;URI, JSDict&lt;String, URI&gt;&gt;
  toLoad: JSArray&lt;URI&gt;
  postLoadHooks: JSDict&lt;URI, (PyretModuleResult -&gt; Undefined)&gt;
)
!→ PyretModuleResult</pre></div><p>Uses <span class="pyret-highlight"><tt class="pyretexpr">toLoad</tt></span>—the list of URIs—to evaluate modules in order.  The modules are found in the <span class="pyret-highlight"><tt class="pyretexpr">modules</tt></span> dictionary, and the <span class="pyret-highlight"><tt class="pyretexpr">dependencies</tt></span> dictionary describes which modules they depend on.  This structure is described in <a href="/Users/ds26gte/src/pyret-docs-pb/internals/modules.html#s:complete">Complete Programs</a>.</p><p>A more important feature of <internal-id>RuntimerunStandalone</internal-id> is the ability to register <span class="pyret-highlight"><tt class="pyretexpr">postLoadHooks</tt></span>.  This dictionary, keyed on URI, contains callbacks which are invoked on completion of the corresponding module, and passed the module’s result.  The most obvious candidate for a <span class="pyret-highlight"><tt class="pyretexpr">postLoadHook</tt></span> is the main module, or the last one in the <span class="pyret-highlight"><tt class="pyretexpr">toLoad</tt></span> list; this is where test results can be fetched and printed and errors reported, based on the returned [REF PyretModuleResult].</p><p>In addition, Pyret’s default standalones register several <span class="pyret-highlight"><tt class="pyretexpr">postLoadHook</tt></span>s. For example, after the <span class="pyret-highlight"><tt class="pyretexpr">ffi</tt></span> library is loaded, a number of new fields are added to <span class="pyret-highlight"><tt class="pyretexpr">runtime</tt></span> to manipulate lists.  Other uses include:</p><ul><li>Substituting a different checker library by setting <span class="pyret-highlight"><tt class="pyretexpr">current-checker</tt></span> after loading the appropriate library.</li><li>Logging the completion time for loading each module in the <span class="pyret-highlight"><tt class="pyretexpr">toLoad</tt></span> list for benchmarking.</li></ul><p>While evaluating the modules, the runtime caches the results for each module that completed successfully, in the <span class="pyret-highlight"><tt class="pyretexpr">runtime.modules</tt></span> dictionary.  This can be accessed later to quickly get the exported values of a module without re-running it.</p><h3 id="Creating-Values" toclevel="3" tocentry="yes">Creating Values</h3><div><pre class="pyret-display">Runtime.makeNumber(JSNumber) → PyretNumber</pre></div><div><pre class="pyret-display">Runtime.makeNumberFromString(JSString) → PyretNumber</pre></div><p>Parses the string and creates a representation of the number that avoids float overflows and can represent very large and very small rationals exactly.</p><div><pre class="pyret-display">Runtime.makeString(JSString) → PyretString</pre></div><p>The representation of Pyret strings is JS strings, though this may change to accommodate better Unicode support in the future.</p><div><pre class="pyret-display">Runtime.pyretTrue :: PyretBoolean</pre></div><div><pre class="pyret-display">Runtime.pyretFalse :: PyretBoolean</pre></div><p>The runtime values for <span class="pyret-highlight"><tt class="pyretexpr">true</tt></span> and <span class="pyret-highlight"><tt class="pyretexpr">false</tt></span> in Pyret.  Representation is JavaScript <span class="pyret-highlight"><tt class="pyretexpr">true</tt></span> and <span class="pyret-highlight"><tt class="pyretexpr">false</tt></span>.</p><div><pre class="pyret-display">Runtime.makeArray(JSArray) → PyretRawArray</pre></div><p>Creates a Pyret <a href="../../../../../..//Users/ds26gte/src/pyret-docs-pb/builtin/raw-arrays.html#RawArray"><span class="pyret-highlight"><tt class="pyretexpr">RawArray</tt></span></a> with the given elements. Currently the identity function: Pyret raw arrays are JavaScript arrays.</p><div><pre class="pyret-display">Runtime.makeObject(JSObj) → PyretObject</pre></div><p>Creates a Pyret object with the fields in the input object.  The representation of an object is <i>not</i> one-to-one with JS objects.</p><p>The fields of a Pyret object go in the <span class="pyret-highlight"><tt class="pyretexpr">dict</tt></span> field of the JS object, and the JS object has an additional field called <span class="pyret-highlight"><tt class="pyretexpr">brands</tt></span>, which hold information about an object’s type information (if it has any). <a href="../../../../../../missing_gloss"><span class="pyret-highlight"><tt class="pyretexpr">StringDict</tt></span></a>s, for example, are branded objects.</p><div><pre class="pyret-display">Runtime.makeFunction(JSFunction) → PyretFunction</pre></div><p>Returns a Pyret function backed by the provided JS function.  The Pyret function will <i>not</i> do any arity checks on behalf of the JS function, so any arity checks need to be done explicitly (see <internal-id>RuntimecheckArity</internal-id>).  The function can be accessed directly via the <span class="pyret-highlight"><tt class="pyretexpr">app</tt></span> field of the Pyret function, but read the section on <internal-id>RuntimesafeCall</internal-id> in order to suitably protect calls to Pyret functions.</p><div><pre class="pyret-display">Runtime.makeMethodN(JSFunction) → PyretMethod</pre></div><h3 id="Interacting-with-Objects" toclevel="3" tocentry="yes">Interacting with Objects</h3><div><pre class="pyret-display">Runtime.getField(PyretObject, JSString) → PyretValue</pre></div><p>Gets the field with the given name from the object.  If the field is a method, it is automatically curried over the object, as with dot.</p><div><pre class="pyret-display">Runtime.getColonField(PyretObject, JSString) → PyretValue</pre></div><p>Gets the field with the given name from the object.  If the field is a method, no additional work is performed.</p><div><pre class="pyret-display">Runtime.getFields(PyretObject) → JSArray&lt;String&gt;</pre></div><p>Returns all the field names of the given object.</p><div><pre class="pyret-display">Runtime.hasField(PyretObject, JSString) → JSBoolean</pre></div><p>Checks if the given object has the named field.</p><h3 id="Assertions" toclevel="3" tocentry="yes">Assertions</h3><div><pre class="pyret-display">Runtime.checkArity(
  JSNumber
  Arguments
  JSString
)
→ Undefined</pre></div><p>Checks that the given argument list has the given arity.  Throws an exception if they don’t match.</p><p>There are a number of checking functions that check that a given argument is of a particular type, and throw an exception if not:</p><div><pre class="pyret-display">Runtime.checkNumber(Any) → Undefined</pre></div><div><pre class="pyret-display">Runtime.checkString(Any) → Undefined</pre></div><div><pre class="pyret-display">Runtime.checkBoolean(Any) → Undefined</pre></div><div><pre class="pyret-display">Runtime.checkObject(Any) → Undefined</pre></div><div><pre class="pyret-display">Runtime.checkFunction(Any) → Undefined</pre></div><div><pre class="pyret-display">Runtime.checkMethod(Any) → Undefined</pre></div><div><pre class="pyret-display">Runtime.checkArray(Any) → Undefined</pre></div><div><pre class="pyret-display">Runtime.checkPyretVal(Any) → Undefined</pre></div><h3 id="runtime:equality" toclevel="3" tocentry="yes">Equality</h3><div><pre class="pyret-display">Runtime.combineEquality(EqualityResult, EqualityResult) → EqualityResult</pre></div><p>Takes two <a href="../../../../../../missing_gloss"><span class="pyret-highlight"><tt class="pyretexpr">EqualityResult</tt></span></a>s and combines them.  Any value paired with <a href="../../../../../../missing_gloss"><span class="pyret-highlight"><tt class="pyretexpr">NotEqual</tt></span></a> produces <a href="../../../../../../missing_gloss"><span class="pyret-highlight"><tt class="pyretexpr">NotEqual</tt></span></a>, any combination of <a href="../../../../../../missing_gloss"><span class="pyret-highlight"><tt class="pyretexpr">Equal</tt></span></a> and <a href="../../../../../../missing_gloss"><span class="pyret-highlight"><tt class="pyretexpr">Unknown</tt></span></a> produces <a href="../../../../../../missing_gloss"><span class="pyret-highlight"><tt class="pyretexpr">Unknown</tt></span></a>, and two <a href="../../../../../../missing_gloss"><span class="pyret-highlight"><tt class="pyretexpr">Equal</tt></span></a> values produce <a href="../../../../../../missing_gloss"><span class="pyret-highlight"><tt class="pyretexpr">Equal</tt></span></a>.</p><h3 id="FFI-Helpers" toclevel="3" tocentry="yes">FFI Helpers</h3><div><pre class="pyret-display">Runtime.ffi :: FFIHelpers</pre></div><p>The Pyret runtime instantiates an <a href="/Users/ds26gte/src/pyret-docs-pb/internals/ffi-helpers.html#ffi"><span class="pyret-highlight"><tt class="pyretexpr">FFIHelpers</tt></span>  object</a> and stores in in the <span class="pyret-highlight"><tt class="pyretexpr">ffi</tt></span> field.</p></root>
    <hr/>
    <!-- The current page is internals/runtime.html. -->
    <a class="floatleft" href="../internal.html">⏴⏴⏴</a>
    <a class="floatright" href="../internals/ffi-helpers.html">⏵⏵⏵</a>
    </div>
  </body>
</html>